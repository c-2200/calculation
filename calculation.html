<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計算練習</title>
  </head>
  <body>
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f2f2f2;
      }
      .questionContainer {
        width: 420px;
        padding: 32px;
        background-color: #ffffff;
        text-align: center;
      }
      .questionStatus {
        font-size: 16px;
        color: #666;
        margin-bottom: 20px;
      }
      .questionText {
        font-size: 40px;
        font-weight: bold;
        margin: 20px 0 30px;
      }
      .answer {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
        font-size: 32px;
      }
      .answerbox {
        min-width: 120px;
        height: 48px;
        border: 2px solid #000;
        text-align: right;
        padding: 5px 10px;
        font-size: 32px;
        box-sizing: border-box;
      }
      .keyboard {
        display: grid;
        grid-template-columns: 105px 105px 105px 105px;
        grid-templaye-rows: 40px 40px 40px 40px;
        font-size: 30px;
        border: 1px
        background-color: #ffffff;
      }
      .keybord button {
        width: 105px;
        height: 40px;
        font-size: 30px;
      }
    </style>
    <div class="questionContainer">
      <div class="questionStatus" id="questionStatus"></div>
      <div class="questionText" id="questionText"></div>
      <div class="answer">
        <div>＝</div>
        <div class="answerBox" id="answer"></div>
      </div>
      <div class="keyboard">
        <button id="1">1</button>
        <button id="2">2</button>
        <button id="3">3</button>
        <button id="-">-</button>
        <button id="4">4</button>
        <button id="5">5</button>
        <button id="6">6</button>
        <button id="/">/</button>
        <button id="7">7</button>
        <button id="8">8</button>
        <button id="9">9</button>
        <button id="backspace">←</button>
        <div></div>
        <button id="0">0</button>
      </div>
    </div>
    <script>
      const info = JSON.parse(localStorage.getItem("calcSettings"));
      const digit1 = Number(info.digit1);
      const digit2 = Number(info.digit2);
      const question = Number(info.question);
      const questionText = document.getElementById("questionText");
      const keyboard = document.querySelector(".keyboard");
      
      function answerCheck(correct) {
        return new Promise(resolve => {
          const answer = document.getElementById("answer");
          if (answer.textContent == correct) {
            resolve();
            return;
          }
          const observer = new MutationObserver(() => {
            if (answer.textContent == correct) {
              observer.disconnect();
              resolve();
            }
          });
          observer.observe(answer, {
            childList: true,
            characterData: true,
            subtree: true
          });
        });
      }
      (async () => {
        for (let i = 1; i <= question; i++) {
          let operator = info.operator;
          document.getElementById("questionStatus").textContent = `第 ${i}/${question} 問目`
          const min1 = 10 ** (digit1 - 1);
          const max1 = 10 ** digit1 - 1;
          const number1 = Math.floor(Math.random() * (max1 - min1 + 1)) + min1;
          const min2 = 10 ** (digit2 - 1);
          const max2 = 10 ** digit2 - 1;
          const number2 = Math.floor(Math.random() * (max2 - min2 + 1)) + min2;
          let answer;
          if (operator == "mix") {
            const items = ["+", "-", "*", "/"];
            operator = items[Math.floor(Math.random() * items.length)];
          }
          if (operator == "+") {
            questionText.textContent = `${number1} ＋ ${number2}`;
            answer = String(number1 + number2);
          } else if (operator == "-") {
            questionText.textContent = `${number1} ー ${number2}`;
            answer = String(number1 - number2);
          } else if (operator == "*") {
            questionText.textContent = `${number1} ✕ ${number2}`;
            answer = String(number1 * number2);
          } else if (operator == "/") {
            function division(numerator, denominator) {
              const gcd = (a, b) => (b === 0 ? a : gcd(b, a % b));
              const g = gcd(numerator, denominator);
              return `${numerator / g}/${denominator / g}`;
            }
            if (number1 % number2 !== 0) {
              answer = division(number1, number2);
            } else {
              answer = String(number1 / number2);
            }
            questionText.textContent = `${number1} ÷ ${number2}`;
          }
          await answerCheck(answer);
          document.getElementById("answer").textContent = "";
        }
      })();
      keyboard.addEventListener("click", (e) => {
        if (e.target.tagName !== "BUTTON") return;
        const id = e.target.id;
        const answer = document.getElementById("answer");
        switch (id) {
          case "backspace":
            document.getElementById("answer").textContent = document.getElementById("answer").textContent.slice(0, -1);
            break;
          case "-":
            if (document.getElementById("answer").textContent == "") {
              document.getElementById("answer").textContent = "-";
              break;
            } else {
              break;
            }
          case "/":
            if (answer.textContent.includes("/") || answer.textContent == "") {
              break;
            } else {
              document.getElementById("answer").textContent += "/";
              break;
            }
          default:
            if (answer.textContent == "" && id == "0") {
              break;
            } else {
              answer.textContent += id
            }
        }
      });
    </script>
  </body>
